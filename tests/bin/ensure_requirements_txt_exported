#!/usr/bin/env bash
set -e

cd "$(dirname "$(dirname "$(dirname "$0")")")"

errmsg() {
    echo -e "\e[01;31m$@\e[0m" >&2
}

success() {
    echo -e "\e[00;32m$@\e[0m" >&2
}

instruct() {
    echo -e "\e[00;33m$@\e[0m" >&2
}

working() {
    echo -e "\e[02;36m$@\e[0m" >&2
}

fatal() {
    errmsg "FATAL: $@"
    exit 1
}

if ! [ -f requirements.txt ]; then
    errmsg "ERROR: requirements.txt does not exist"
    instruct "Please run the following command:"
    instruct "    poetry export -f requirements.txt -o requirements.txt"
    exit 1
fi

if ! [ -f requirements_dev.txt ]; then
    errmsg "ERROR: requirements_dev.txt does not exist"
    instruct "Please run the following command:"
    instruct "    poetry export -f requirements.txt -o requirements_dev.txt --dev"
    exit 1
fi

# ensure poetry is available
which poetry >/dev/null || fatal "'poetry' command is not available"

working "Creating temporary directory" 
tmpdir=$(mktemp -d)

working "Exporting $tmpdir/requirements.txt using poetry"
poetry export -f requirements.txt -o "$tmpdir/requirements.txt" || fatal could not export requirements.txt
working "Exporting $tmpdir/requirements_dev.txt using poetry"
poetry export -f requirements.txt -o "$tmpdir/requirements_dev.txt" --dev || fatal could not export requirements_dev.txt

for f in requirements.txt requirements_dev.txt; do
    if ! diff "$f" "$tmpdir/$f"; then
        errmsg "ERROR: $f generated by poetry is different to the version in this repo"
        instruct "Please run the following command:"
        instruct "    poetry export -f requirements.txt -o requirements.txt"
        exit 1
    fi
done

working "Cleaning up $tmpdir"
rm -rf "$tmpdir"

success "requirements.txt and requirements_dev.txt are up to date"
